# Storage å­˜å‚¨åŒ…

ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€é«˜åº¦å¯æ‰©å±•çš„Goè¯­è¨€æ–‡ä»¶å­˜å‚¨åŒ…ï¼Œæ”¯æŒå¤šç§å­˜å‚¨åç«¯å’Œé«˜çº§æ–‡ä»¶å¤„ç†åŠŸèƒ½ã€‚

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

### 1. å¤šå­˜å‚¨åç«¯æ”¯æŒï¼ˆç­–ç•¥æ¨¡å¼ï¼‰
- **æœ¬åœ°å­˜å‚¨**ï¼šæ”¯æŒæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨
- **ä¸ƒç‰›äº‘å­˜å‚¨**ï¼šé›†æˆä¸ƒç‰›äº‘å¯¹è±¡å­˜å‚¨æœåŠ¡
- **é˜¿é‡Œäº‘OSS**ï¼šæ”¯æŒé˜¿é‡Œäº‘å¯¹è±¡å­˜å‚¨æœåŠ¡
- **è…¾è®¯äº‘COS**ï¼šé›†æˆè…¾è®¯äº‘å¯¹è±¡å­˜å‚¨æœåŠ¡
- **å¯æ‰©å±•æ¶æ„**ï¼šåŸºäºç­–ç•¥æ¨¡å¼ï¼Œè½»æ¾æ·»åŠ æ–°çš„å­˜å‚¨åç«¯

### 2. å¤§æ–‡ä»¶å¤„ç†èƒ½åŠ›
- **å¹¶å‘åˆ†ç‰‡ä¸Šä¼ **ï¼šè‡ªåŠ¨å°†å¤§æ–‡ä»¶åˆ†ç‰‡å¹¶å‘ä¸Šä¼ ï¼Œæå‡ä¼ è¾“æ•ˆç‡
- **ç§’ä¼ åŠŸèƒ½**ï¼šåŸºäºæ–‡ä»¶MD5æ ¡éªŒï¼Œå®ç°æ–‡ä»¶ç§’ä¼ 
- **æ–­ç‚¹ç»­ä¼ **ï¼šæ”¯æŒç½‘ç»œä¸­æ–­åçš„æ–­ç‚¹ç»­ä¼ åŠŸèƒ½
- **æ™ºèƒ½åˆ†ç‰‡**ï¼šæ ¹æ®æ–‡ä»¶å¤§å°å’Œç½‘ç»œçŠ¶å†µè‡ªåŠ¨è°ƒæ•´åˆ†ç‰‡ç­–ç•¥

### 3. å®‰å…¨æ ¡éªŒé“¾ï¼ˆè´£ä»»é“¾æ¨¡å¼ï¼‰
- **æ–‡ä»¶ç±»å‹æ ¡éªŒ**ï¼šæ”¯æŒç™½åå•/é»‘åå•æ¨¡å¼çš„æ–‡ä»¶ç±»å‹æ£€æŸ¥
- **æ–‡ä»¶å¤§å°é™åˆ¶**ï¼šå¯é…ç½®çš„æ–‡ä»¶å¤§å°ä¸Šé™æ£€æŸ¥
- **ç—…æ¯’æ‰«æ**ï¼šé›†æˆç—…æ¯’æ‰«æå¼•æ“ï¼Œç¡®ä¿æ–‡ä»¶å®‰å…¨
- **å†…å®¹æ£€æµ‹**ï¼šæ”¯æŒæ•æ„Ÿå†…å®¹æ£€æµ‹å’Œè¿‡æ»¤
- **å¯æ‰©å±•æ ¡éªŒ**ï¼šåŸºäºè´£ä»»é“¾æ¨¡å¼ï¼Œè½»æ¾æ·»åŠ è‡ªå®šä¹‰æ ¡éªŒè§„åˆ™

### 4. äº‹ä»¶é’©å­ç³»ç»Ÿ
- **ä¸Šä¼ å‰é’©å­**ï¼šæ–‡ä»¶ä¸Šä¼ å‰çš„é¢„å¤„ç†å’Œæ ¡éªŒ
- **ä¸Šä¼ ä¸­é’©å­**ï¼šä¸Šä¼ è¿‡ç¨‹ä¸­çš„è¿›åº¦ç›‘æ§å’ŒçŠ¶æ€æ›´æ–°
- **ä¸Šä¼ å®Œæˆé’©å­**ï¼šä¸Šä¼ å®Œæˆåçš„åå¤„ç†æ“ä½œ
- **æ¸…ç†é’©å­**ï¼šæ–‡ä»¶åˆ é™¤å’Œæ¸…ç†æ—¶çš„å›è°ƒå¤„ç†
- **é”™è¯¯é’©å­**ï¼šå¼‚å¸¸æƒ…å†µçš„å¤„ç†å’Œé€šçŸ¥

### 5. HTTP Handler æ”¯æŒ
- **RESTful API**ï¼šæä¾›æ ‡å‡†çš„æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½ã€åˆ é™¤æ¥å£
- **è¿›åº¦ç›‘æ§**ï¼šå®æ—¶ä¸Šä¼ /ä¸‹è½½è¿›åº¦åé¦ˆ
- **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒæ‰¹é‡æ–‡ä»¶ä¸Šä¼ å’Œç®¡ç†
- **é¢„ç­¾åURL**ï¼šç”Ÿæˆä¸´æ—¶è®¿é—®é“¾æ¥
- **ä¸­é—´ä»¶é›†æˆ**ï¼šä¸Ginç­‰Webæ¡†æ¶æ— ç¼é›†æˆ

## ğŸ“ é¡¹ç›®ç»“æ„

```
storage/
â”œâ”€â”€ README.md              # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ interface.go           # æ ¸å¿ƒæ¥å£å®šä¹‰
â”œâ”€â”€ factory.go             # å­˜å‚¨å·¥å‚ç±»
â”œâ”€â”€ manager.go             # å­˜å‚¨ç®¡ç†å™¨
â”œâ”€â”€ qiniu.go              # ä¸ƒç‰›äº‘å­˜å‚¨å®ç°
â”œâ”€â”€ tencent.go            # è…¾è®¯äº‘COSå®ç°
â”œâ”€â”€ alioss.go             # é˜¿é‡Œäº‘OSSå®ç°ï¼ˆå¾…å®ç°ï¼‰
â”œâ”€â”€ local.go              # æœ¬åœ°å­˜å‚¨å®ç°ï¼ˆå¾…å®ç°ï¼‰
â”œâ”€â”€ validator/            # æ ¡éªŒå™¨ç›®å½•
â”‚   â”œâ”€â”€ chain.go          # è´£ä»»é“¾æ¨¡å¼å®ç°
â”‚   â”œâ”€â”€ file_type.go      # æ–‡ä»¶ç±»å‹æ ¡éªŒ
â”‚   â”œâ”€â”€ file_size.go      # æ–‡ä»¶å¤§å°æ ¡éªŒ
â”‚   â””â”€â”€ virus_scan.go     # ç—…æ¯’æ‰«ææ ¡éªŒ
â”œâ”€â”€ uploader/             # ä¸Šä¼ å™¨ç›®å½•
â”‚   â”œâ”€â”€ chunked.go        # åˆ†ç‰‡ä¸Šä¼ å®ç°
â”‚   â”œâ”€â”€ resumable.go      # æ–­ç‚¹ç»­ä¼ å®ç°
â”‚   â””â”€â”€ concurrent.go     # å¹¶å‘ä¸Šä¼ å®ç°
â”œâ”€â”€ hooks/                # äº‹ä»¶é’©å­ç›®å½•
â”‚   â”œâ”€â”€ interface.go      # é’©å­æ¥å£å®šä¹‰
â”‚   â”œâ”€â”€ manager.go        # é’©å­ç®¡ç†å™¨
â”‚   â””â”€â”€ builtin.go        # å†…ç½®é’©å­å®ç°
â””â”€â”€ handler/              # HTTPå¤„ç†å™¨ç›®å½•
    â”œâ”€â”€ upload.go         # ä¸Šä¼ å¤„ç†å™¨
    â”œâ”€â”€ download.go       # ä¸‹è½½å¤„ç†å™¨
    â”œâ”€â”€ manage.go         # ç®¡ç†å¤„ç†å™¨
    â””â”€â”€ middleware.go     # ä¸­é—´ä»¶
```

## ğŸ”§ å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ä½¿ç”¨

```go
package main

import (
    "context"
    "log"
    "github.com/your-org/sweet/internal/pkg/storage"
)

func main() {
    // åˆ›å»ºå­˜å‚¨ç®¡ç†å™¨
    manager := storage.NewStorageManager()
    
    // æ³¨å†Œä¸ƒç‰›äº‘å­˜å‚¨
    qiniuConfig := &storage.QiniuConfig{
        AccessKey: "your-access-key",
        SecretKey: "your-secret-key",
        Bucket:    "your-bucket",
        Domain:    "your-domain",
    }
    
    err := manager.RegisterStorage(storage.Qiniu, qiniuConfig)
    if err != nil {
        log.Fatal(err)
    }
    
    // è®¾ç½®é»˜è®¤å­˜å‚¨
    manager.SetDefaultStorage(storage.Qiniu)
    
    // ä¸Šä¼ æ–‡ä»¶
    file, _ := os.Open("example.jpg")
    defer file.Close()
    
    result, err := manager.UploadToDefault(
        context.Background(),
        "images/example.jpg",
        file,
        1024*1024, // 1MB
        &storage.UploadOptions{
            ContentType: "image/jpeg",
        },
    )
    
    if err != nil {
        log.Fatal(err)
    }
    
    log.Printf("æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: %s", result.URL)
}
```

### é…ç½®æ ¡éªŒé“¾

```go
// åˆ›å»ºæ ¡éªŒé“¾
validatorChain := validator.NewChain()

// æ·»åŠ æ–‡ä»¶ç±»å‹æ ¡éªŒ
validatorChain.Add(&validator.FileTypeValidator{
    AllowedTypes: []string{".jpg", ".png", ".pdf"},
})

// æ·»åŠ æ–‡ä»¶å¤§å°æ ¡éªŒ
validatorChain.Add(&validator.FileSizeValidator{
    MaxSize: 10 * 1024 * 1024, // 10MB
})

// æ·»åŠ ç—…æ¯’æ‰«æ
validatorChain.Add(&validator.VirusScanValidator{
    ScanEngine: "clamav",
})

// åœ¨ä¸Šä¼ æ—¶ä½¿ç”¨æ ¡éªŒé“¾
uploadOptions := &storage.UploadOptions{
    Validator: validatorChain,
}
```

### é…ç½®äº‹ä»¶é’©å­

```go
// åˆ›å»ºé’©å­ç®¡ç†å™¨
hookManager := hooks.NewManager()

// æ³¨å†Œä¸Šä¼ å‰é’©å­
hookManager.RegisterBeforeUpload(func(ctx context.Context, key string, size int64) error {
    log.Printf("å‡†å¤‡ä¸Šä¼ æ–‡ä»¶: %s, å¤§å°: %d", key, size)
    return nil
})

// æ³¨å†Œä¸Šä¼ å®Œæˆé’©å­
hookManager.RegisterAfterUpload(func(ctx context.Context, result *storage.UploadResult) error {
    log.Printf("æ–‡ä»¶ä¸Šä¼ å®Œæˆ: %s", result.URL)
    // å¯ä»¥åœ¨è¿™é‡Œå‘é€é€šçŸ¥ã€æ›´æ–°æ•°æ®åº“ç­‰
    return nil
})

// åœ¨å­˜å‚¨ç®¡ç†å™¨ä¸­ä½¿ç”¨é’©å­
manager.SetHookManager(hookManager)
```

### HTTP Handler é›†æˆ

```go
package main

import (
    "github.com/gin-gonic/gin"
    "github.com/your-org/sweet/internal/pkg/storage"
    "github.com/your-org/sweet/internal/pkg/storage/handler"
)

func main() {
    // åˆ›å»ºå­˜å‚¨ç®¡ç†å™¨
    manager := storage.NewStorageManager()
    // ... é…ç½®å­˜å‚¨åç«¯
    
    // åˆ›å»ºHTTPå¤„ç†å™¨
    uploadHandler := handler.NewUploadHandler(manager)
    downloadHandler := handler.NewDownloadHandler(manager)
    
    // åˆ›å»ºGinè·¯ç”±
    r := gin.Default()
    
    // æ³¨å†Œè·¯ç”±
    api := r.Group("/api/v1")
    {
        api.POST("/upload", uploadHandler.Upload)
        api.POST("/upload/chunked", uploadHandler.ChunkedUpload)
        api.GET("/download/:key", downloadHandler.Download)
        api.DELETE("/files/:key", uploadHandler.Delete)
        api.GET("/files/:key/info", uploadHandler.GetFileInfo)
    }
    
    r.Run(":8080")
}
```

## ğŸ”§ é…ç½®è¯´æ˜

### å­˜å‚¨åç«¯é…ç½®

#### ä¸ƒç‰›äº‘é…ç½®
```go
type QiniuConfig struct {
    AccessKey string `json:"access_key" yaml:"access_key"`
    SecretKey string `json:"secret_key" yaml:"secret_key"`
    Bucket    string `json:"bucket" yaml:"bucket"`
    Domain    string `json:"domain" yaml:"domain"`
    UseHTTPS  bool   `json:"use_https" yaml:"use_https"`
    Zone      string `json:"zone" yaml:"zone"` // å­˜å‚¨åŒºåŸŸ
}
```

#### è…¾è®¯äº‘COSé…ç½®
```go
type TencentConfig struct {
    SecretID  string `json:"secret_id" yaml:"secret_id"`
    SecretKey string `json:"secret_key" yaml:"secret_key"`
    Region    string `json:"region" yaml:"region"`
    Bucket    string `json:"bucket" yaml:"bucket"`
    Domain    string `json:"domain" yaml:"domain"`
}
```

### åˆ†ç‰‡ä¸Šä¼ é…ç½®
```go
type ChunkedUploadConfig struct {
    ChunkSize    int64 `json:"chunk_size"`    // åˆ†ç‰‡å¤§å°ï¼Œé»˜è®¤5MB
    MaxChunks    int   `json:"max_chunks"`    // æœ€å¤§åˆ†ç‰‡æ•°
    Concurrency  int   `json:"concurrency"`   // å¹¶å‘æ•°ï¼Œé»˜è®¤3
    RetryTimes   int   `json:"retry_times"`   // é‡è¯•æ¬¡æ•°
    EnableResume bool  `json:"enable_resume"` // æ˜¯å¦å¯ç”¨æ–­ç‚¹ç»­ä¼ 
}
```

### å­˜å‚¨é…ç½®æ–‡ä»¶

#### YAMLé…ç½®ç¤ºä¾‹
```yaml
# storage.yaml
storage:
  # é»˜è®¤å­˜å‚¨ç±»å‹
  default: "qiniu"
  
  # æ–‡ä»¶ä¸Šä¼ é™åˆ¶
  upload:
    # å…¨å±€æ–‡ä»¶å¤§å°é™åˆ¶ (å­—èŠ‚)
    max_file_size: 104857600  # 100MB
    
    # å…è®¸çš„æ–‡ä»¶ç±»å‹ (ç™½åå•æ¨¡å¼)
    allowed_types:
      - ".jpg"
      - ".jpeg"
      - ".png"
      - ".gif"
      - ".pdf"
      - ".doc"
      - ".docx"
      - ".xls"
      - ".xlsx"
      - ".ppt"
      - ".pptx"
      - ".txt"
      - ".zip"
      - ".rar"
    
    # ç¦æ­¢çš„æ–‡ä»¶ç±»å‹ (é»‘åå•æ¨¡å¼)
    forbidden_types:
      - ".exe"
      - ".bat"
      - ".cmd"
      - ".scr"
      - ".vbs"
      - ".js"
      - ".jar"
    
    # æŒ‰æ–‡ä»¶ç±»å‹çš„å¤§å°é™åˆ¶
    type_size_limits:
      image:  # å›¾ç‰‡ç±»å‹
        types: [".jpg", ".jpeg", ".png", ".gif"]
        max_size: 10485760  # 10MB
      document:  # æ–‡æ¡£ç±»å‹
        types: [".pdf", ".doc", ".docx", ".xls", ".xlsx", ".ppt", ".pptx"]
        max_size: 52428800  # 50MB
      archive:  # å‹ç¼©åŒ…ç±»å‹
        types: [".zip", ".rar", ".7z"]
        max_size: 104857600  # 100MB
    
    # åˆ†ç‰‡ä¸Šä¼ é…ç½®
    chunked:
      enabled: true
      chunk_size: 5242880  # 5MB
      max_chunks: 1000
      concurrency: 3
      retry_times: 3
      enable_resume: true
      # å¤§äºæ­¤å¤§å°çš„æ–‡ä»¶è‡ªåŠ¨å¯ç”¨åˆ†ç‰‡ä¸Šä¼ 
      auto_chunk_threshold: 20971520  # 20MB
  
  # å®‰å…¨æ ¡éªŒé…ç½®
  security:
    # ç—…æ¯’æ‰«æ
    virus_scan:
      enabled: true
      engine: "clamav"
      timeout: 30  # æ‰«æè¶…æ—¶æ—¶é—´(ç§’)
      async: true   # å¼‚æ­¥æ‰«æ
    
    # å†…å®¹æ£€æµ‹
    content_detection:
      enabled: true
      # æ•æ„Ÿè¯æ£€æµ‹
      sensitive_words: true
      # å›¾ç‰‡å†…å®¹æ£€æµ‹
      image_content: true
  
  # å­˜å‚¨åç«¯é…ç½®
  backends:
    # ä¸ƒç‰›äº‘é…ç½®
    qiniu:
      access_key: "${QINIU_ACCESS_KEY}"
      secret_key: "${QINIU_SECRET_KEY}"
      bucket: "${QINIU_BUCKET}"
      domain: "${QINIU_DOMAIN}"
      use_https: true
      zone: "z0"  # åä¸œ
    
    # è…¾è®¯äº‘COSé…ç½®
    tencent:
      secret_id: "${TENCENT_SECRET_ID}"
      secret_key: "${TENCENT_SECRET_KEY}"
      region: "ap-beijing"
      bucket: "${TENCENT_BUCKET}"
      domain: "${TENCENT_DOMAIN}"
    
    # é˜¿é‡Œäº‘OSSé…ç½®
    alioss:
      access_key_id: "${ALIOSS_ACCESS_KEY_ID}"
      access_key_secret: "${ALIOSS_ACCESS_KEY_SECRET}"
      endpoint: "oss-cn-hangzhou.aliyuncs.com"
      bucket: "${ALIOSS_BUCKET}"
      domain: "${ALIOSS_DOMAIN}"
    
    # æœ¬åœ°å­˜å‚¨é…ç½®
    local:
      root_path: "./uploads"
      url_prefix: "/static/uploads"
      create_date_dir: true  # æŒ‰æ—¥æœŸåˆ›å»ºç›®å½•
  
  # ç¼“å­˜é…ç½®
  cache:
    # æ–‡ä»¶å…ƒæ•°æ®ç¼“å­˜
    metadata:
      enabled: true
      ttl: 3600  # ç¼“å­˜æ—¶é—´(ç§’)
      max_size: 10000  # æœ€å¤§ç¼“å­˜æ¡ç›®æ•°
    
    # é¢„ç­¾åURLç¼“å­˜
    presigned_url:
      enabled: true
      ttl: 1800  # ç¼“å­˜æ—¶é—´(ç§’)
      max_size: 5000
  
  # äº‹ä»¶é’©å­é…ç½®
  hooks:
    # ä¸Šä¼ å‰é’©å­
    before_upload:
      - "validate_user_quota"  # éªŒè¯ç”¨æˆ·é…é¢
      - "check_duplicate"      # æ£€æŸ¥é‡å¤æ–‡ä»¶
    
    # ä¸Šä¼ å®Œæˆé’©å­
    after_upload:
      - "update_user_quota"    # æ›´æ–°ç”¨æˆ·é…é¢
      - "send_notification"    # å‘é€é€šçŸ¥
      - "generate_thumbnail"   # ç”Ÿæˆç¼©ç•¥å›¾
    
    # åˆ é™¤é’©å­
    before_delete:
      - "check_permission"     # æ£€æŸ¥åˆ é™¤æƒé™
    
    after_delete:
      - "cleanup_cache"        # æ¸…ç†ç¼“å­˜
      - "update_statistics"    # æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
  
  # ç›‘æ§é…ç½®
  monitoring:
    # æŒ‡æ ‡æ”¶é›†
    metrics:
      enabled: true
      interval: 60  # æ”¶é›†é—´éš”(ç§’)
    
    # æ—¥å¿—é…ç½®
    logging:
      level: "info"
      format: "json"
      # æ•æ„Ÿä¿¡æ¯è„±æ•
      mask_sensitive: true
```

#### JSONé…ç½®ç¤ºä¾‹
```json
{
  "storage": {
    "default": "qiniu",
    "upload": {
      "max_file_size": 104857600,
      "allowed_types": [".jpg", ".jpeg", ".png", ".pdf"],
      "forbidden_types": [".exe", ".bat", ".cmd"],
      "type_size_limits": {
        "image": {
          "types": [".jpg", ".jpeg", ".png", ".gif"],
          "max_size": 10485760
        }
      },
      "chunked": {
        "enabled": true,
        "chunk_size": 5242880,
        "concurrency": 3,
        "enable_resume": true
      }
    },
    "backends": {
      "qiniu": {
        "access_key": "your-access-key",
        "secret_key": "your-secret-key",
        "bucket": "your-bucket",
        "domain": "your-domain",
        "use_https": true
      }
    }
  }
}
```

#### Goé…ç½®ç»“æ„ä½“
```go
// StorageConfig å­˜å‚¨é…ç½®
type StorageConfig struct {
    Default string                    `json:"default" yaml:"default"`
    Upload  UploadConfig             `json:"upload" yaml:"upload"`
    Security SecurityConfig          `json:"security" yaml:"security"`
    Backends map[string]interface{}  `json:"backends" yaml:"backends"`
    Cache   CacheConfig             `json:"cache" yaml:"cache"`
    Hooks   HooksConfig             `json:"hooks" yaml:"hooks"`
    Monitoring MonitoringConfig      `json:"monitoring" yaml:"monitoring"`
}

// UploadConfig ä¸Šä¼ é…ç½®
type UploadConfig struct {
    MaxFileSize      int64                          `json:"max_file_size" yaml:"max_file_size"`
    AllowedTypes     []string                       `json:"allowed_types" yaml:"allowed_types"`
    ForbiddenTypes   []string                       `json:"forbidden_types" yaml:"forbidden_types"`
    TypeSizeLimits   map[string]TypeSizeLimit       `json:"type_size_limits" yaml:"type_size_limits"`
    Chunked         ChunkedUploadConfig            `json:"chunked" yaml:"chunked"`
}

// TypeSizeLimit æŒ‰ç±»å‹çš„å¤§å°é™åˆ¶
type TypeSizeLimit struct {
    Types   []string `json:"types" yaml:"types"`
    MaxSize int64    `json:"max_size" yaml:"max_size"`
}

// SecurityConfig å®‰å…¨é…ç½®
type SecurityConfig struct {
    VirusScan        VirusScanConfig        `json:"virus_scan" yaml:"virus_scan"`
    ContentDetection ContentDetectionConfig `json:"content_detection" yaml:"content_detection"`
}

// VirusScanConfig ç—…æ¯’æ‰«æé…ç½®
type VirusScanConfig struct {
    Enabled bool   `json:"enabled" yaml:"enabled"`
    Engine  string `json:"engine" yaml:"engine"`
    Timeout int    `json:"timeout" yaml:"timeout"`
    Async   bool   `json:"async" yaml:"async"`
}

// ContentDetectionConfig å†…å®¹æ£€æµ‹é…ç½®
type ContentDetectionConfig struct {
    Enabled        bool `json:"enabled" yaml:"enabled"`
    SensitiveWords bool `json:"sensitive_words" yaml:"sensitive_words"`
    ImageContent   bool `json:"image_content" yaml:"image_content"`
}

// CacheConfig ç¼“å­˜é…ç½®
type CacheConfig struct {
    Metadata     CacheItemConfig `json:"metadata" yaml:"metadata"`
    PresignedURL CacheItemConfig `json:"presigned_url" yaml:"presigned_url"`
}

// CacheItemConfig ç¼“å­˜é¡¹é…ç½®
type CacheItemConfig struct {
    Enabled bool `json:"enabled" yaml:"enabled"`
    TTL     int  `json:"ttl" yaml:"ttl"`
    MaxSize int  `json:"max_size" yaml:"max_size"`
}

// HooksConfig é’©å­é…ç½®
type HooksConfig struct {
    BeforeUpload []string `json:"before_upload" yaml:"before_upload"`
    AfterUpload  []string `json:"after_upload" yaml:"after_upload"`
    BeforeDelete []string `json:"before_delete" yaml:"before_delete"`
    AfterDelete  []string `json:"after_delete" yaml:"after_delete"`
}

// MonitoringConfig ç›‘æ§é…ç½®
type MonitoringConfig struct {
    Metrics MetricsConfig `json:"metrics" yaml:"metrics"`
    Logging LoggingConfig `json:"logging" yaml:"logging"`
}

// MetricsConfig æŒ‡æ ‡é…ç½®
type MetricsConfig struct {
    Enabled  bool `json:"enabled" yaml:"enabled"`
    Interval int  `json:"interval" yaml:"interval"`
}

// LoggingConfig æ—¥å¿—é…ç½®
type LoggingConfig struct {
    Level         string `json:"level" yaml:"level"`
    Format        string `json:"format" yaml:"format"`
    MaskSensitive bool   `json:"mask_sensitive" yaml:"mask_sensitive"`
}
```

### é…ç½®æ–‡ä»¶åŠ è½½

```go
package main

import (
    "fmt"
    "log"
    "gopkg.in/yaml.v3"
    "os"
    "github.com/your-org/sweet/internal/pkg/storage"
)

// LoadStorageConfig åŠ è½½å­˜å‚¨é…ç½®
func LoadStorageConfig(configPath string) (*StorageConfig, error) {
    data, err := os.ReadFile(configPath)
    if err != nil {
        return nil, fmt.Errorf("è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥: %v", err)
    }
    
    var config StorageConfig
    if err := yaml.Unmarshal(data, &config); err != nil {
        return nil, fmt.Errorf("è§£æé…ç½®æ–‡ä»¶å¤±è´¥: %v", err)
    }
    
    // éªŒè¯é…ç½®
    if err := validateConfig(&config); err != nil {
        return nil, fmt.Errorf("é…ç½®éªŒè¯å¤±è´¥: %v", err)
    }
    
    return &config, nil
}

// validateConfig éªŒè¯é…ç½®
func validateConfig(config *StorageConfig) error {
    if config.Default == "" {
        return fmt.Errorf("å¿…é¡»æŒ‡å®šé»˜è®¤å­˜å‚¨ç±»å‹")
    }
    
    if config.Upload.MaxFileSize <= 0 {
        return fmt.Errorf("æœ€å¤§æ–‡ä»¶å¤§å°å¿…é¡»å¤§äº0")
    }
    
    // éªŒè¯å­˜å‚¨åç«¯é…ç½®
    if _, exists := config.Backends[config.Default]; !exists {
        return fmt.Errorf("é»˜è®¤å­˜å‚¨ç±»å‹ %s çš„é…ç½®ä¸å­˜åœ¨", config.Default)
    }
    
    return nil
}

// InitStorageWithConfig ä½¿ç”¨é…ç½®åˆå§‹åŒ–å­˜å‚¨
func InitStorageWithConfig(configPath string) (*storage.StorageManager, error) {
    config, err := LoadStorageConfig(configPath)
    if err != nil {
        return nil, err
    }
    
    manager := storage.NewStorageManager()
    
    // æ³¨å†Œå­˜å‚¨åç«¯
    for backendType, backendConfig := range config.Backends {
        storageType, err := storage.ParseStorageType(backendType)
        if err != nil {
            log.Printf("è·³è¿‡æœªçŸ¥å­˜å‚¨ç±»å‹: %s", backendType)
            continue
        }
        
        // æ ¹æ®ç±»å‹åˆ›å»ºå…·ä½“é…ç½®
        var storageConfig storage.Config
        switch storageType {
        case storage.Qiniu:
            storageConfig = createQiniuConfig(backendConfig)
        case storage.TencentCOS:
            storageConfig = createTencentConfig(backendConfig)
        // ... å…¶ä»–å­˜å‚¨ç±»å‹
        }
        
        if err := manager.RegisterStorage(storageType, storageConfig); err != nil {
            return nil, fmt.Errorf("æ³¨å†Œå­˜å‚¨ %s å¤±è´¥: %v", backendType, err)
        }
    }
    
    // è®¾ç½®é»˜è®¤å­˜å‚¨
    defaultType, _ := storage.ParseStorageType(config.Default)
    if err := manager.SetDefaultStorage(defaultType); err != nil {
        return nil, fmt.Errorf("è®¾ç½®é»˜è®¤å­˜å‚¨å¤±è´¥: %v", err)
    }
    
    return manager, nil
}

func main() {
    // ä»é…ç½®æ–‡ä»¶åˆå§‹åŒ–å­˜å‚¨
    manager, err := InitStorageWithConfig("./config/storage.yaml")
    if err != nil {
        log.Fatal(err)
    }
    
    // ä½¿ç”¨å­˜å‚¨ç®¡ç†å™¨
    // ...
}
```

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

### æ–‡ä»¶ç±»å‹æ ¡éªŒ
- æ”¯æŒåŸºäºæ–‡ä»¶æ‰©å±•åçš„ç™½åå•/é»‘åå•è¿‡æ»¤
- æ”¯æŒåŸºäºMIMEç±»å‹çš„å†…å®¹æ£€æµ‹
- æ”¯æŒåŸºäºæ–‡ä»¶å¤´çš„çœŸå®ç±»å‹æ£€æµ‹

### æ–‡ä»¶å¤§å°é™åˆ¶
- æ”¯æŒå…¨å±€æ–‡ä»¶å¤§å°é™åˆ¶
- æ”¯æŒæŒ‰æ–‡ä»¶ç±»å‹çš„å·®å¼‚åŒ–å¤§å°é™åˆ¶
- æ”¯æŒåŠ¨æ€è°ƒæ•´å¤§å°é™åˆ¶

### ç—…æ¯’æ‰«æ
- é›†æˆClamAVç—…æ¯’æ‰«æå¼•æ“
- æ”¯æŒè‡ªå®šä¹‰ç—…æ¯’æ‰«ææœåŠ¡
- å¼‚æ­¥æ‰«æï¼Œä¸å½±å“ä¸Šä¼ æ€§èƒ½

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### å¹¶å‘ä¸Šä¼ 
- è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶å¤§å°ï¼Œæ™ºèƒ½é€‰æ‹©ä¸Šä¼ ç­–ç•¥
- å¤§æ–‡ä»¶è‡ªåŠ¨å¯ç”¨åˆ†ç‰‡å¹¶å‘ä¸Šä¼ 
- å¯é…ç½®çš„å¹¶å‘æ•°å’Œåˆ†ç‰‡å¤§å°

### ç¼“å­˜ç­–ç•¥
- æ–‡ä»¶å…ƒæ•°æ®ç¼“å­˜ï¼Œå‡å°‘é‡å¤æŸ¥è¯¢
- é¢„ç­¾åURLç¼“å­˜ï¼Œæå‡è®¿é—®é€Ÿåº¦
- æ™ºèƒ½ç¼“å­˜å¤±æ•ˆæœºåˆ¶

### è¿æ¥æ± 
- HTTPå®¢æˆ·ç«¯è¿æ¥æ± å¤ç”¨
- æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–
- åˆç†çš„è¶…æ—¶å’Œé‡è¯•æœºåˆ¶

## ğŸ” ç›‘æ§å’Œæ—¥å¿—

### æŒ‡æ ‡ç›‘æ§
- ä¸Šä¼ /ä¸‹è½½æˆåŠŸç‡
- å¹³å‡å“åº”æ—¶é—´
- æ–‡ä»¶å¤§å°åˆ†å¸ƒ
- å­˜å‚¨åç«¯å¥åº·çŠ¶æ€

### æ—¥å¿—è®°å½•
- ç»“æ„åŒ–æ—¥å¿—è¾“å‡º
- å¯é…ç½®çš„æ—¥å¿—çº§åˆ«
- æ•æ„Ÿä¿¡æ¯è„±æ•
- é“¾è·¯è¿½è¸ªæ”¯æŒ

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
go test ./...

# è¿è¡ŒåŸºå‡†æµ‹è¯•
go test -bench=. ./...

# ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out
```

## ğŸ“ è®¸å¯è¯

MIT License

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥å¸®åŠ©æ”¹è¿›è¿™ä¸ªé¡¹ç›®ã€‚

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- æäº¤GitHub Issue
- å‘é€é‚®ä»¶è‡³ï¼šsupport@example.com

---

**æ³¨æ„**ï¼šæœ¬æ–‡æ¡£æè¿°çš„æ˜¯å­˜å‚¨åŒ…çš„å®Œæ•´åŠŸèƒ½è§„åˆ’ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä»åœ¨å¼€å‘ä¸­ã€‚è¯·æŸ¥çœ‹å…·ä½“çš„å®ç°æ–‡ä»¶äº†è§£å½“å‰å¯ç”¨çš„åŠŸèƒ½ã€‚